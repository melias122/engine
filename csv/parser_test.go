package csv

import (
	"bytes"
	"testing"
)

func TestParser(t *testing.T) {
	testCase := []struct {
		name       string
		p          *Parser
		combs      [][]int
		shouldFail bool
	}{
		{name: "Empty", p: NewParser(bytes.NewReader([]byte(``)), 5, 35), shouldFail: true},
		{name: "OnlyHeader", p: NewParser(bytes.NewReader([]byte(`ID;DATUM; TYZDEN;1;2;3;4;5`)), 5, 35), shouldFail: true},
		{name: "BadFormat", p: NewParser(bytes.NewReader(dataset535_bad), 5, 35)},
		{name: "BadNumber", p: NewParser(bytes.NewReader(dataset535_badNum), 5, 35), shouldFail: true},
		{name: "ShortLine", p: NewParser(bytes.NewReader(dataset535_badShortLine), 5, 35), shouldFail: true},
		{name: "Long", p: NewParser(bytes.NewReader(dataset535), 5, 35)},
		{name: "Short", p: NewParser(bytes.NewReader(dataset535_short), 5, 35), combs: [][]int{
			{2, 7, 13, 32, 35},
			{1, 14, 15, 17, 19},
			{17, 21, 29, 32, 34}},
		},
	}

	for _, tc := range testCase {
		t.Run(tc.name, func(t *testing.T) {
			combs, err := tc.p.Parse()
			if (tc.shouldFail && err == nil) || (err != nil && !tc.shouldFail) {
				t.Fatal(err)
			}
			if tc.shouldFail {
				t.Log(err)
				return
			}

			if len(tc.combs) == 0 {
				t.Log("skipings comparision")
				return
			}

			for i, comb := range combs {
				for j := range comb {
					if comb[j] != tc.combs[i][j] {
						t.Fatalf("expected %v got %v", tc.combs[i], comb)
					}
				}
			}
		})
	}
}

var dataset535_badNum = []byte(`ID;DATUM; TYZDEN;1;2;3;4;5
1;16.1.1994;3;2;7;13;32.123;35
2;30.1.1994;5;1;14;15;17;19
3;13.3.1994;11;17;21;29;32;34`)

var dataset535_badShortLine = []byte(`ID;DATUM; TYZDEN;1;2;3;4;5
1;16.1.1994;3;2;7;13;32
2;30.1.1994;5;1;14;15;17;19
3;13.3.1994;11;17;21;29;32;34`)

var dataset535_bad = []byte(`ID;DATUM; TYZDEN;1;2;3;4;5
1;16.1.1994;3;2;7;13;32;35;;
2;30.1.1994;5;1;14;15;17;19;;;;;;123;
3;13.3.1994;11;17;21;29;32;34;;;`)

var dataset535_short = []byte(`ID;DATUM; TYZDEN;1;2;3;4;5
1;16.1.1994;3;2;7;13;32;35
2;30.1.1994;5;1;14;15;17;19
3;13.3.1994;11;17;21;29;32;34`)

var dataset535 = []byte(`ID;DATUM; TYZDEN;1;2;3;4;5
1;16.1.1994;3;2;7;13;32;35
2;30.1.1994;5;1;14;15;17;19
3;13.2.1994;7;4;9;10;25;27
4;27.2.1994;9;1;2;13;21;31
5;13.3.1994;11;17;21;29;32;34
6;27.3.1994;13;14;16;23;30;34
7;10.4.1994;15;1;3;6;16;26
8;24.4.1994;17;3;6;7;23;24
9;8.5.1994;19;11;16;23;30;31
10;22.5.1994;21;8;12;20;22;25
11;5.6.1994;23;6;18;29;32;35
12;11.9.1994;37;4;15;17;20;23
13;25.9.1994;39;7;9;13;16;24
14;9.10.1994;41;1;26;27;28;30
15;23.10.1994;43;8;10;23;33;34
16;6.11.1994;45;2;5;6;18;27
17;20.11.1994;47;17;25;27;31;32
18;4.12.1994;49;24;27;29;31;33
19;18.12.1994;51;2;17;19;30;32
20;1.1.1995;53;15;17;19;28;34
21;15.1.1995;3;5;14;23;27;29
22;29.1.1995;5;9;14;17;31;32
23;12.2.1995;7;8;10;28;29;33
24;26.2.1995;9;7;13;20;29;33
25;12.3.1995;11;8;12;32;33;35
26;26.3.1995;13;6;10;18;20;32
27;9.4.1995;15;7;11;12;26;35
28;23.4.1995;17;6;8;14;26;29
29;7.5.1995;19;10;14;20;21;28
30;21.5.1995;21;1;4;6;25;32
31;4.6.1995;23;3;5;15;19;24
32;18.6.1995;25;3;18;19;25;30
33;2.7.1995;27;5;8;25;31;32
34;16.7.1995;29;3;5;15;23;31
35;30.7.1995;31;3;12;16;21;29
36;13.8.1995;33;1;2;3;29;33
37;27.8.1995;35;1;2;18;32;33
38;10.9.1995;37;3;7;12;22;35
39;24.9.1995;39;12;16;18;29;32
40;8.10.1995;41;13;16;19;31;35
41;22.10.1995;43;9;12;15;32;34
42;5.11.1995;45;10;12;20;25;35
43;19.11.1995;47;16;25;27;33;35
44;3.12.1995;49;4;8;9;14;33
45;17.12.1995;51;7;16;27;28;29
46;31.12.1995;53;1;3;10;17;33
47;14.1.1996;2;6;8;15;18;30
48;28.1.1996;4;9;19;21;24;32
49;11.2.1996;6;9;11;16;30;33
50;25.2.1996;8;7;18;22;32;34
51;10.3.1996;10;6;10;22;26;28
52;24.3.1996;12;5;10;20;23;26
53;7.4.1996;14;4;25;27;30;34
54;21.4.1996;16;12;22;29;31;32
55;5.5.1996;18;5;22;30;31;34
56;19.5.1996;20;7;14;17;26;30
57;2.6.1996;22;11;12;15;22;23
58;16.6.1996;24;2;9;11;32;33
59;30.6.1996;26;2;12;15;21;24
60;14.7.1996;28;5;8;18;31;32
61;28.7.1996;30;5;11;13;19;34
62;11.8.1996;32;5;7;16;28;35
63;25.8.1996;34;2;12;14;22;33
64;8.9.1996;36;5;6;28;31;33
65;22.9.1996;38;5;8;18;23;29
66;6.10.1996;40;15;18;20;30;34
67;20.10.1996;42;4;10;11;17;21
68;3.11.1996;44;9;11;23;26;32
69;17.11.1996;46;1;8;15;28;30
70;1.12.1996;48;1;4;17;19;28
71;15.12.1996;50;6;13;16;18;28
72;29.12.1996;52;4;11;12;17;29
73;12.1.1997;2;4;9;10;17;32
74;19.1.1997;3;10;16;20;23;34
75;26.1.1997;4;5;6;7;13;26
76;2.2.1997;5;11;13;17;31;32
77;9.2.1997;6;11;16;17;20;34
78;16.2.1997;7;11;23;26;33;34
79;23.2.1997;8;4;8;21;23;24
80;2.3.1997;9;2;4;7;30;34
81;9.3.1997;10;6;10;19;32;33
82;16.3.1997;11;14;31;33;34;35
83;23.3.1997;12;2;3;9;21;31
84;30.3.1997;13;3;7;15;25;27
85;6.4.1997;14;6;12;22;29;35
86;13.4.1997;15;6;7;8;17;27
87;20.4.1997;16;12;21;23;29;32
88;27.4.1997;17;8;17;21;34;35
89;4.5.1997;18;2;3;9;32;35
90;11.5.1997;19;2;12;15;31;34
91;18.5.1997;20;10;26;28;32;35
92;25.5.1997;21;5;12;22;23;29
93;1.6.1997;22;14;17;19;23;34
94;8.6.1997;23;1;6;18;26;30
95;15.6.1997;24;4;25;31;32;33
96;22.6.1997;25;9;21;23;29;33
97;29.6.1997;26;4;5;8;12;27
98;6.7.1997;27;8;11;21;24;27
99;13.7.1997;28;2;18;19;25;35
100;20.7.1997;29;1;11;21;24;32`)
